import { useEffect, useState } from 'react';
import supabase from '@/utils/supabaseClient';
import styles from '@/styles/crtLaunch.module.css';
import { format } from 'date-fns';
import { downloadCSV } from '@/utils/exportCSV';
import RouteGuard from '@/components/RouteGuard';

interface GuardianConsent {
Â  id: string;
Â  user_id: string;
Â  name: string;
Â  email: string;
Â  relation: string;
Â  timestamp: string;
Â  agreed: boolean;
}

function GuardianInboxContent() {
Â  const [consents, setConsents] = useState<GuardianConsent[]>([]);
Â  const [loading, setLoading] = useState(true);

Â  useEffect(() => {
Â  Â  (async () => {
Â  Â  Â  const { data } = await supabase
Â  Â  Â  Â  .from('guardian_consent')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .order('timestamp', { ascending: false });

Â  Â  Â  setConsents(data || []);
Â  Â  Â  setLoading(false);
Â  Â  })();
Â  }, []);

Â  const handleExport = () => downloadCSV(consents, 'guardian_consent_log');

Â  return (
Â  Â  <div className={styles.crtScreen}>
Â  Â  Â  <h1>ğŸ“¬ GUARDIAN INBOX</h1>
Â  Â  Â  <p>Submitted parental consents and child onboarding approvals.</p>
Â  Â  Â  <button className={styles.crtButton} onClick={handleExport}>ğŸ“¤ Export CSV</button>

Â  Â  Â  {loading ? (
Â  Â  Â  Â  <p>Loading...</p>
Â  Â  Â  ) : consents.length === 0 ? (
Â  Â  Â  Â  <p>ğŸ“­ No guardian entries found.</p>
Â  Â  Â  ) : (
Â  Â  Â  Â  <ul style={{ marginTop: '2rem' }}>
Â  Â  Â  Â  Â  {consents.map((entry) => (
Â  Â  Â  Â  Â  Â  <li
Â  Â  Â  Â  Â  Â  Â  key={entry.id}
Â  Â  Â  Â  Â  Â  Â  style={{
Â  Â  Â  Â  Â  Â  Â  Â  marginBottom: '1.5rem',
Â  Â  Â  Â  Â  Â  Â  Â  padding: '1rem',
Â  Â  Â  Â  Â  Â  Â  Â  border: '1px solid #0ff',
Â  Â  Â  Â  Â  Â  Â  Â  borderRadius: '6px',
Â  Â  Â  Â  Â  Â  Â  Â  background: '#111',
Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  <p><strong>Name:</strong> {entry.name}</p>
Â  Â  Â  Â  Â  Â  Â  <p><strong>Email:</strong> {entry.email}</p>
Â  Â  Â  Â  Â  Â  Â  <p><strong>Relation:</strong> {entry.relation}</p>
Â  Â  Â  Â  Â  Â  Â  <p><strong>Consent:</strong> {entry.agreed ? 'âœ… Agreed' : 'âŒ Not Agreed'}</p>
Â  Â  Â  Â  Â  Â  Â  <p style={{ fontSize: '0.8rem', color: '#888' }}>
Â  Â  Â  Â  Â  Â  Â  Â  <strong>Timestamp:</strong> {format(new Date(entry.timestamp), 'PPpp')}
Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </ul>
Â  Â  Â  )}
Â  Â  </div>
Â  );
}

export default function GuardianInboxPage() {
Â  return (
Â  Â  <RouteGuard allowedRoles={['admin', 'developer']}>
Â  Â  Â  <GuardianInboxContent />
Â  Â  </RouteGuard>
Â  );
}